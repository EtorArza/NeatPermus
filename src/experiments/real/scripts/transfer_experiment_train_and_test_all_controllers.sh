#!/bin/bash

source scripts/array_to_string_functions.sh


COMPILE_JOB_ID=`sbatch --parsable scripts/make_hip.sh --exclude=n[001-004,017-018]`

SRCDIR=`pwd`

# #region Not executed
if false; then
echo "this part not executed"
# ... Code I want to skip here ...
fi
# #endregion




######################## REAL TRANSFER #################################
EXPERIMENT_FOLDER_NAME="src/experiments/real/results/transferability/controllers_trained_on_random_instances"
COMPUTE_RESPONSE="true"
SCORE_PATH="src/experiments/real/results/transferability/transfer_score.txt"
RESPONSE_PATH="src/experiments/real/results/transferability/transfer_response.txt"
TMP_RES_PATH="${SRCDIR}/tmp/${EXPERIMENT_FOLDER_NAME}"
N_REPS=1
N_EVALS=1000
MAX_TRAIN_ITERATIONS=200

standard_NEAT_POPSIZE=128
standard_NLO=10
standard_DIM=10
standard_SOLVER_POPSIZE=20
standard_MAX_SOLVER_FE=10000
########################################################################





###########################################################################################################################
EXP_NAME="NLO"
NEAT_POPSIZE_ARRAY=()
CONTROLLER_NAME_PREFIX_ARRAY=()
EXPERIMENT_FOLDER_NAME_ARRAY=()
SEED_ARRAY=()
PROBLEM_NLO_ARRAY=()
PROBLEM_DIM_ARRAY=()
SOLVER_POPSIZE_ARRAY=()
MAX_SOLVER_FE_ARRAY=()


i=-1
for NLO_train in 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40; do
    i=$((i+1))

    NEAT_POPSIZE_ARRAY+=("${standard_NEAT_POPSIZE}")
    CONTROLLER_NAME_PREFIX_ARRAY+=("NLO_${NLO_train}")
    EXPERIMENT_FOLDER_NAME_ARRAY+=("${EXPERIMENT_FOLDER_NAME}")
    SEED_ARRAY+=("${i}")
    PROBLEM_NLO_ARRAY+=("${NLO_train}")
    PROBLEM_DIM_ARRAY+=("${standard_DIM}")
    SOLVER_POPSIZE_ARRAY+=("${standard_SOLVER_POPSIZE}")
    MAX_SOLVER_FE_ARRAY+=("${standard_MAX_SOLVER_FE}")
done




NEAT_POPSIZE_ARRAY=$(to_list "${NEAT_POPSIZE_ARRAY[@]}")
CONTROLLER_NAME_PREFIX_ARRAY=$(to_list "${CONTROLLER_NAME_PREFIX_ARRAY[@]}")
EXPERIMENT_FOLDER_NAME_ARRAY=$(to_list "${EXPERIMENT_FOLDER_NAME_ARRAY[@]}")
SEED_ARRAY=$(to_list "${SEED_ARRAY[@]}")
PROBLEM_NLO_ARRAY=$(to_list "${PROBLEM_NLO_ARRAY[@]}")
PROBLEM_DIM_ARRAY=$(to_list "${PROBLEM_DIM_ARRAY[@]}")
SOLVER_POPSIZE_ARRAY=$(to_list "${SOLVER_POPSIZE_ARRAY[@]}")
MAX_SOLVER_FE_ARRAY=$(to_list "${MAX_SOLVER_FE_ARRAY[@]}")


# launch training and get JOB_ID to queue test to launch only after training is complete
TRAINING_JOB_ID=`sbatch --parsable --dependency=afterok:${COMPILE_JOB_ID} --export=MAX_TRAIN_ITERATIONS=${MAX_TRAIN_ITERATIONS},NEAT_POPSIZE_ARRAY=$NEAT_POPSIZE_ARRAY,CONTROLLER_NAME_PREFIX_ARRAY=$CONTROLLER_NAME_PREFIX_ARRAY,EXPERIMENT_FOLDER_NAME_ARRAY=$EXPERIMENT_FOLDER_NAME_ARRAY,SEED_ARRAY=$SEED_ARRAY,PROBLEM_NLO_ARRAY=$PROBLEM_NLO_ARRAY,PROBLEM_DIM_ARRAY=$PROBLEM_DIM_ARRAY,SOLVER_POPSIZE_ARRAY=$SOLVER_POPSIZE_ARRAY,MAX_SOLVER_FE_ARRAY=$MAX_SOLVER_FE_ARRAY --array=0-$i src/experiments/real/scripts/hip_train_array_random_problem.sl`



TESTING_JOB_ID=""


NEAT_POPSIZE_ARRAY=()
CONTROLLER_NAME_PREFIX_ARRAY=()
EXPERIMENT_FOLDER_NAME_ARRAY=()
SEED_ARRAY=()
PROBLEM_NLO_ARRAY=()
PROBLEM_DIM_ARRAY=()
SOLVER_POPSIZE_ARRAY=()
MAX_SOLVER_FE_ARRAY=()
i=-1
for NLO_train in 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40; do
    for NLO_test in 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40; do
        i=$((i+1))

        NEAT_POPSIZE_ARRAY+=("${standard_NEAT_POPSIZE}")
        CONTROLLER_NAME_PREFIX_ARRAY+=("NLO_${NLO_train}")
        EXPERIMENT_FOLDER_NAME_ARRAY+=("${EXPERIMENT_FOLDER_NAME}")
        SEED_ARRAY+=("${i}")
        PROBLEM_NLO_ARRAY+=("${NLO_test}")
        PROBLEM_DIM_ARRAY+=("${standard_DIM}")
        SOLVER_POPSIZE_ARRAY+=("${standard_SOLVER_POPSIZE}")
        MAX_SOLVER_FE_ARRAY+=("${standard_MAX_SOLVER_FE}")
    done
done

NEAT_POPSIZE_ARRAY=$(to_list "${NEAT_POPSIZE_ARRAY[@]}")
CONTROLLER_NAME_PREFIX_ARRAY=$(to_list "${CONTROLLER_NAME_PREFIX_ARRAY[@]}")
EXPERIMENT_FOLDER_NAME_ARRAY=$(to_list "${EXPERIMENT_FOLDER_NAME_ARRAY[@]}")
SEED_ARRAY=$(to_list "${SEED_ARRAY[@]}")
PROBLEM_NLO_ARRAY=$(to_list "${PROBLEM_NLO_ARRAY[@]}")
PROBLEM_DIM_ARRAY=$(to_list "${PROBLEM_DIM_ARRAY[@]}")
SOLVER_POPSIZE_ARRAY=$(to_list "${SOLVER_POPSIZE_ARRAY[@]}")
MAX_SOLVER_FE_ARRAY=$(to_list "${MAX_SOLVER_FE_ARRAY[@]}")

TESTING_JOB_ID=`sbatch --parsable --dependency=afterok:${TRAINING_JOB_ID} --export=EXPERIMENT_FOLDER_NAME=${EXPEIMENT_FOLDER_NAME},COMPUTE_RESPONSE=${COMPUTE_RESPONSE},SCORE_PATH=${SCORE_PATH},RESPONSE_PATH=${RESPONSE_PATH},TMP_RES_PATH=${TMP_RES_PATH},N_REPS=${N_REPS},N_EVALS=${N_EVALS},EXP_NAME=${EXP_NAME},NEAT_POPSIZE_ARRAY=$NEAT_POPSIZE_ARRAY,CONTROLLER_NAME_PREFIX_ARRAY=$CONTROLLER_NAME_PREFIX_ARRAY,EXPERIMENT_FOLDER_NAME_ARRAY=$EXPERIMENT_FOLDER_NAME_ARRAY,SEED_ARRAY=$SEED_ARRAY,PROBLEM_NLO_ARRAY=$PROBLEM_NLO_ARRAY,PROBLEM_DIM_ARRAY=$PROBLEM_DIM_ARRAY,SOLVER_POPSIZE_ARRAY=$SOLVER_POPSIZE_ARRAY,MAX_SOLVER_FE_ARRAY=$MAX_SOLVER_FE_ARRAY --array=0-$i src/experiments/real/scripts/hip_test_array.sl`


sbatch --dependency=afterok:$TESTING_JOB_ID --export=SCORE_PATH=${SCORE_PATH},RESPONSE_PATH=${RESPONSE_PATH},COMPUTE_RESPONSE=${COMPUTE_RESPONSE},TMP_RES_PATH=${TMP_RES_PATH} scripts/cat_result_files_to_exp_folder.sh



###########################################################################################################################



EXP_NAME="DIM"
NEAT_POPSIZE_ARRAY=()
CONTROLLER_NAME_PREFIX_ARRAY=()
EXPERIMENT_FOLDER_NAME_ARRAY=()
SEED_ARRAY=()
PROBLEM_NLO_ARRAY=()
PROBLEM_DIM_ARRAY=()
SOLVER_POPSIZE_ARRAY=()
MAX_SOLVER_FE_ARRAY=()


i=-1
for DIM_train in 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40; do
    i=$((i+1))

    NEAT_POPSIZE_ARRAY+=("${standard_NEAT_POPSIZE}")
    CONTROLLER_NAME_PREFIX_ARRAY+=("DIM_${DIM_train}")
    EXPERIMENT_FOLDER_NAME_ARRAY+=("${EXPERIMENT_FOLDER_NAME}")
    SEED_ARRAY+=("${i}")
    PROBLEM_NLO_ARRAY+=("${standard_NLO}")
    PROBLEM_DIM_ARRAY+=("${DIM_train}")
    SOLVER_POPSIZE_ARRAY+=("${standard_SOLVER_POPSIZE}")
    MAX_SOLVER_FE_ARRAY+=("${standard_MAX_SOLVER_FE}")
done




NEAT_POPSIZE_ARRAY=$(to_list "${NEAT_POPSIZE_ARRAY[@]}")
CONTROLLER_NAME_PREFIX_ARRAY=$(to_list "${CONTROLLER_NAME_PREFIX_ARRAY[@]}")
EXPERIMENT_FOLDER_NAME_ARRAY=$(to_list "${EXPERIMENT_FOLDER_NAME_ARRAY[@]}")
SEED_ARRAY=$(to_list "${SEED_ARRAY[@]}")
PROBLEM_NLO_ARRAY=$(to_list "${PROBLEM_NLO_ARRAY[@]}")
PROBLEM_DIM_ARRAY=$(to_list "${PROBLEM_DIM_ARRAY[@]}")
SOLVER_POPSIZE_ARRAY=$(to_list "${SOLVER_POPSIZE_ARRAY[@]}")
MAX_SOLVER_FE_ARRAY=$(to_list "${MAX_SOLVER_FE_ARRAY[@]}")



TRAINING_JOB_ID=`sbatch --parsable --dependency=afterok:${COMPILE_JOB_ID} --export=MAX_TRAIN_ITERATIONS=${MAX_TRAIN_ITERATIONS},NEAT_POPSIZE_ARRAY=$NEAT_POPSIZE_ARRAY,CONTROLLER_NAME_PREFIX_ARRAY=$CONTROLLER_NAME_PREFIX_ARRAY,EXPERIMENT_FOLDER_NAME_ARRAY=$EXPERIMENT_FOLDER_NAME_ARRAY,SEED_ARRAY=$SEED_ARRAY,PROBLEM_NLO_ARRAY=$PROBLEM_NLO_ARRAY,PROBLEM_DIM_ARRAY=$PROBLEM_DIM_ARRAY,SOLVER_POPSIZE_ARRAY=$SOLVER_POPSIZE_ARRAY,MAX_SOLVER_FE_ARRAY=$MAX_SOLVER_FE_ARRAY --array=0-$i src/experiments/real/scripts/hip_train_array_random_problem.sl`



TESTING_JOB_ID=""


NEAT_POPSIZE_ARRAY=()
CONTROLLER_NAME_PREFIX_ARRAY=()
EXPERIMENT_FOLDER_NAME_ARRAY=()
SEED_ARRAY=()
PROBLEM_NLO_ARRAY=()
PROBLEM_DIM_ARRAY=()
SOLVER_POPSIZE_ARRAY=()
MAX_SOLVER_FE_ARRAY=()
i=-1
for DIM_train in 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40; do
    for DIM_test in 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40; do
        i=$((i+1))

        NEAT_POPSIZE_ARRAY+=("${standard_NEAT_POPSIZE}")
        CONTROLLER_NAME_PREFIX_ARRAY+=("DIM_${DIM_train}")
        EXPERIMENT_FOLDER_NAME_ARRAY+=("${EXPERIMENT_FOLDER_NAME}")
        SEED_ARRAY+=("${i}")
        PROBLEM_NLO_ARRAY+=("${standard_NLO}")
        PROBLEM_DIM_ARRAY+=("${DIM_test}")
        SOLVER_POPSIZE_ARRAY+=("${standard_SOLVER_POPSIZE}")
        MAX_SOLVER_FE_ARRAY+=("${standard_MAX_SOLVER_FE}")
    done
done

NEAT_POPSIZE_ARRAY=$(to_list "${NEAT_POPSIZE_ARRAY[@]}")
CONTROLLER_NAME_PREFIX_ARRAY=$(to_list "${CONTROLLER_NAME_PREFIX_ARRAY[@]}")
EXPERIMENT_FOLDER_NAME_ARRAY=$(to_list "${EXPERIMENT_FOLDER_NAME_ARRAY[@]}")
SEED_ARRAY=$(to_list "${SEED_ARRAY[@]}")
PROBLEM_NLO_ARRAY=$(to_list "${PROBLEM_NLO_ARRAY[@]}")
PROBLEM_DIM_ARRAY=$(to_list "${PROBLEM_DIM_ARRAY[@]}")
SOLVER_POPSIZE_ARRAY=$(to_list "${SOLVER_POPSIZE_ARRAY[@]}")
MAX_SOLVER_FE_ARRAY=$(to_list "${MAX_SOLVER_FE_ARRAY[@]}")

TESTING_JOB_ID=`sbatch --parsable --dependency=afterok:${TRAINING_JOB_ID} --export=EXPERIMENT_FOLDER_NAME=${EXPEIMENT_FOLDER_NAME},COMPUTE_RESPONSE=${COMPUTE_RESPONSE},SCORE_PATH=${SCORE_PATH},RESPONSE_PATH=${RESPONSE_PATH},TMP_RES_PATH=${TMP_RES_PATH},N_REPS=${N_REPS},N_EVALS=${N_EVALS},EXP_NAME=${EXP_NAME},NEAT_POPSIZE_ARRAY=$NEAT_POPSIZE_ARRAY,CONTROLLER_NAME_PREFIX_ARRAY=$CONTROLLER_NAME_PREFIX_ARRAY,EXPERIMENT_FOLDER_NAME_ARRAY=$EXPERIMENT_FOLDER_NAME_ARRAY,SEED_ARRAY=$SEED_ARRAY,PROBLEM_NLO_ARRAY=$PROBLEM_NLO_ARRAY,PROBLEM_DIM_ARRAY=$PROBLEM_DIM_ARRAY,SOLVER_POPSIZE_ARRAY=$SOLVER_POPSIZE_ARRAY,MAX_SOLVER_FE_ARRAY=$MAX_SOLVER_FE_ARRAY --array=0-$i src/experiments/real/scripts/hip_test_array.sl`


sbatch --dependency=afterok:$TESTING_JOB_ID --export=SCORE_PATH=${SCORE_PATH},RESPONSE_PATH=${RESPONSE_PATH},COMPUTE_RESPONSE=${COMPUTE_RESPONSE},TMP_RES_PATH=${TMP_RES_PATH} scripts/cat_result_files_to_exp_folder.sh



